stages:
- prebuild
- build
- publish

# TODO We should probably fixe the version and not use master HERE.

.build:  &build
  stage: build
  image: $DOCKER_REGISTRY/pdsl/cbcpy-build:$CI_PIPELINE_IID
  before_script:
  # Install & Compile CBC
  - wget https://raw.githubusercontent.com/coin-or/coinbrew/master/coinbrew
  - bash ./coinbrew fetch https://github.com/coin-or/Cbc --no-prompt --no-third-party
  - bash ./coinbrew build Cbc --no-prompt --parallel-jobs=`nproc` --disable-shared

# Create a Docker images with SWIG
prebuild-docker-image:
  image: docker:stable
  stage: prebuild
  script:
  - docker login $DOCKER_REGISTRY -u $DOCKER_USR -p $DOCKER_PWD
  - docker build -t cbcpy-build .
  - docker tag cbcpy-build $DOCKER_REGISTRY/pdsl/cbcpy-build:$CI_PIPELINE_IID
  - docker push $DOCKER_REGISTRY/pdsl/cbcpy-build:$CI_PIPELINE_IID

build:py2:
  <<: *build
  script:
  - python2 setup.py build_ext --swig-cpp --swig-opts="-I./build/include/coin/" -I./build/include/coin/ -L./build/lib/ -lCbcSolver -lCbc -lCgl -lOsiClp -lOsiCbc -lOsi -lClp

build:py3:
  <<: *build
  script:
  - python3 setup.py build_ext --swig-cpp --swig-opts="-I./build/include/coin/" -I./build/include/coin/ -L./build/lib/ -lCbcSolver -lCbc -lCgl -lOsiClp -lOsiCbc -lOsi -lClp
  
